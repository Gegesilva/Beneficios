ALTER FUNCTION [dbo].[FTVENCIDO_PERIODO] (
    @DATAINI DATE,
    @DATAFIM DATE
)
RETURNS 
@TABELA TABLE (
    MES INT,
    ANO INT,
    PERIODO0A30_TITULO NUMERIC(11,2) DEFAULT 0,
    PERIODO0A90_TITULO NUMERIC(11,2) DEFAULT 0,
    PERIODO0A365_TITULO NUMERIC(11,2) DEFAULT 0,
    PERIODOALL_TITULO NUMERIC(11,2) DEFAULT 0,
    PERIODO0A30_PAGO NUMERIC(11,2) DEFAULT 0,
    PERIODO0A90_PAGO NUMERIC(11,2) DEFAULT 0,
    PERIODO0A365_PAGO NUMERIC(11,2) DEFAULT 0,
    PERIODOALL_PAGO NUMERIC(11,2) DEFAULT 0,
    INAD0A30 AS PERIODO0A30_TITULO - PERIODO0A30_PAGO,
    PERC0A30  AS CAST((PERIODO0A30_TITULO - PERIODO0A30_PAGO) / NULLIF(PERIODO0A30_TITULO,0) * 100 AS NUMERIC(11,2)),
    INAD0A90 AS PERIODO0A90_TITULO - PERIODO0A90_PAGO,
    PERC0A90  AS CAST((PERIODO0A90_TITULO - PERIODO0A90_PAGO) / NULLIF(PERIODO0A90_TITULO,0) * 100 AS NUMERIC(11,2)),
    INAD0A365 AS PERIODO0A365_TITULO - PERIODO0A365_PAGO,
    PERC0A365  AS CAST((PERIODO0A365_TITULO - PERIODO0A365_PAGO) / NULLIF(PERIODO0A365_TITULO,0) * 100 AS NUMERIC(11,2)),
    INADALL AS PERIODOALL_TITULO - PERIODOALL_PAGO,
    PERCALL  AS CAST((PERIODOALL_TITULO - PERIODOALL_PAGO) / NULLIF(PERIODOALL_TITULO,0) * 100 AS NUMERIC(11,2))
)
AS
BEGIN
    DECLARE 
        @VLR0A30_TITULO NUMERIC(11,2),
        @VLR0A90_TITULO NUMERIC(11,2),
        @VLR0A365_TITULO NUMERIC(11,2),
        @VLRALL_TITULO NUMERIC(11,2),
        @VLR0A30_PAGO NUMERIC(11,2),
        @VLR0A90_PAGO NUMERIC(11,2),
        @VLR0A365_PAGO NUMERIC(11,2),
        @VLRALL_PAGO NUMERIC(11,2),
        @DATAREF DATE = DATEFROMPARTS(YEAR(@DATAINI), MONTH(@DATAINI), 1),
        @MES INT,
        @ANO INT,
        @DATAINI_MES DATE,
        @DATAFIM_MES DATE

    WHILE @DATAREF <= @DATAFIM
    BEGIN
        SET @MES = MONTH(@DATAREF)
        SET @ANO = YEAR(@DATAREF)
        
        SET @DATAINI_MES = CASE 
                            WHEN @DATAINI > EOMONTH(@DATAREF, -1) THEN @DATAINI 
                            ELSE DATEFROMPARTS(@ANO, @MES, 1) 
                           END

        SET @DATAFIM_MES = CASE 
                            WHEN @DATAFIM < EOMONTH(@DATAREF) THEN @DATAFIM 
                            ELSE EOMONTH(@DATAREF) 
                           END

        INSERT INTO @TABELA(MES, ANO) VALUES (@MES, @ANO)

        -- 0 A 30 DIAS - TÍTULO
        SELECT @VLR0A30_TITULO = SUM(ISNULL(TB04010_VLRTITULO,0))
        FROM TB04010
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN @DATAINI_MES AND @DATAFIM_MES

        -- 0 A 90 DIAS - TÍTULO
        SELECT @VLR0A90_TITULO = SUM(ISNULL(TB04010_VLRTITULO,0))
        FROM TB04010
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN DATEADD(MONTH,-1,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES

        -- 0 A 365 DIAS - TÍTULO
        SELECT @VLR0A365_TITULO = SUM(ISNULL(TB04010_VLRTITULO,0))
        FROM TB04010
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN DATEADD(MONTH,-11,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES

        -- TODOS - TÍTULO
        SELECT @VLRALL_TITULO = SUM(ISNULL(TB04010_VLRTITULO,0))
        FROM TB04010
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) <= @DATAFIM_MES

        -- 0 A 30 DIAS - PAGO
        SELECT @VLR0A30_PAGO = SUM(ISNULL(TB04010_VLRPAGO,0))
        FROM TB04010
        LEFT JOIN TB04011 ON TB04011_CODIGO = TB04010_CODIGO 
                         AND TB04011_CODEMP = TB04010_CODEMP 
                         AND TB04011_CODCLI = TB04010_CODCLI
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN @DATAINI_MES AND @DATAFIM_MES
          AND CAST(TB04011_DTBAIXA AS DATE) BETWEEN @DATAINI_MES AND @DATAFIM_MES

        -- 0 A 90 DIAS - PAGO
        SELECT @VLR0A90_PAGO = SUM(ISNULL(TB04010_VLRPAGO,0))
        FROM TB04010
        LEFT JOIN TB04011 ON TB04011_CODIGO = TB04010_CODIGO 
                         AND TB04011_CODEMP = TB04010_CODEMP 
                         AND TB04011_CODCLI = TB04010_CODCLI
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN DATEADD(MONTH,-1,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES
          AND CAST(TB04011_DTBAIXA AS DATE) BETWEEN DATEADD(MONTH,-1,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES

        -- 0 A 365 DIAS - PAGO
        SELECT @VLR0A365_PAGO = SUM(ISNULL(TB04010_VLRPAGO,0))
        FROM TB04010
        LEFT JOIN TB04011 ON TB04011_CODIGO = TB04010_CODIGO 
                         AND TB04011_CODEMP = TB04010_CODEMP 
                         AND TB04011_CODCLI = TB04010_CODCLI
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) BETWEEN DATEADD(MONTH,-11,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES
          AND CAST(TB04011_DTBAIXA AS DATE) BETWEEN DATEADD(MONTH,-11,DATEADD(DAY, 1, EOMONTH(@DATAREF,-2))) AND @DATAFIM_MES

        -- TODOS - PAGO
        SELECT @VLRALL_PAGO = SUM(ISNULL(TB04010_VLRPAGO,0))
        FROM TB04010
        LEFT JOIN TB04011 ON TB04011_CODIGO = TB04010_CODIGO 
                         AND TB04011_CODEMP = TB04010_CODEMP 
                         AND TB04011_CODCLI = TB04010_CODCLI
        WHERE CAST(TB04010_DTVENCORIGINAL AS DATE) <= @DATAFIM_MES
          --AND CAST(TB04011_DTBAIXA AS DATE) <= @DATAFIM_MES

        -- Atualiza tabela
        UPDATE @TABELA
        SET PERIODO0A30_TITULO = ISNULL(@VLR0A30_TITULO, 0),
            PERIODO0A90_TITULO = ISNULL(@VLR0A90_TITULO, 0),
            PERIODO0A365_TITULO = ISNULL(@VLR0A365_TITULO, 0),
            PERIODOALL_TITULO = ISNULL(@VLRALL_TITULO, 0),
            PERIODO0A30_PAGO = ISNULL(@VLR0A30_PAGO, 0),
            PERIODO0A90_PAGO = ISNULL(@VLR0A90_PAGO, 0),
            PERIODO0A365_PAGO = ISNULL(@VLR0A365_PAGO, 0),
            PERIODOALL_PAGO = ISNULL(@VLRALL_PAGO, 0)
        WHERE MES = @MES AND ANO = @ANO

        SET @DATAREF = DATEADD(MONTH, 1, @DATAREF)
    END

    RETURN
END
